<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>XWiki</web>
<name>GroovyConsoleExecutor</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent>XWiki.WebHome</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1241713705000</creationDate>
<date>1339758848000</date>
<contentUpdateDate>1339758848000</contentUpdateDate>
<version>3.1</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Imported from XAR</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/1.0</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator>|</separator>
<separators>|,</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>XWiki.GroovyConsoleExecutor</name>
<number>0</number>
<className>XWiki.TagClass</className>
<guid>3aab2d1a-40d5-480f-aa0f-35f500b8a2a1</guid>
<property>
<tags/>
</property>
</object>
<content>{pre}
&lt;%
import org.codehaus.groovy.control.MultipleCompilationErrorsException

if(request.xpage == "plain" &amp;&amp; xwiki.hasAccessLevel("programming", doc.fullName)) {

def scriptText = request.getParameter("script") ?: "'The received script was null.'"

def output = new StringWriter()
def binding = new Binding([out: new PrintWriter(output), xwiki:xwiki, context:context, request:request, util:util])

def stacktrace = new StringWriter()
def errWriter = new PrintWriter(stacktrace)

def result = ""
try {
	result = new GroovyShell(binding).evaluate(scriptText)
} catch (MultipleCompilationErrorsException e) {
	stacktrace.append(e.message - 'startup failed, Script1.groovy: ')
} catch (Throwable t) {
	sanitizeStacktrace(t)
	def cause = t
	while (cause = cause?.cause) {
		sanitizeStacktrace(cause)
	}
	t.printStackTrace(errWriter)
}

response.contentType = "application/json"

out.println "{ executionResult: \"" + escape(result) + "\", " + "outputText: \"" + escape(output) + "\", " + "stacktraceText: \"" + escape(stacktrace) + "\"}"

}

else {
   println "This is a groovy executor"
}

def escape(object) {
	object.toString().replaceAll(/\n/, /\\\n/).replaceAll(/"/, /\\"/)
}

def sanitizeStacktrace(t) {
    def filtered = [
        'com.google.', 'org.mortbay.',
        'java.', 'javax.', 'sun.', 
        'groovy.', 'org.codehaus.groovy.', 
        'com.xpn.xwiki.render', 'org.apache.velocity',
        'org.xwiki.velocity', 'com.xpn.xwiki',
        'org.apache.struts', 'Script1'
	]
    def trace = t.getStackTrace()
    def newTrace = []
    trace.each { stackTraceElement -&gt; 
        if (filtered.every { !stackTraceElement.className.startsWith(it) }) {
            newTrace &lt;&lt; stackTraceElement
        }
    }
    def clean = newTrace.toArray(newTrace as StackTraceElement[])
    t.stackTrace = clean
}

%&gt;
{/pre}</content></xwikidoc>
